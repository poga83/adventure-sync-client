<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Adventure Sync</title>
    
    <!-- Leaflet + Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ */
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .chat-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            width: 300px;
        }

        .route-instructions {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- –í–µ—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π HTML -->

    <!-- –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <div id="chat-modal" class="chat-modal">
        <div class="modal-content">
            <h3>–ß–∞—Ç —Å <span id="chat-with-name"></span></h3>
            <div id="private-chat-messages" class="route-instructions"></div>
            <input type="text" id="private-message-input">
            <button onclick="sendPrivateMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="closeChatModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let routingControl = null;
let currentChatUserId = null;

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
function createUserMarker(user) {
    const color = statusColors[user.status] || '#6c757d';
    const emoji = user.status.split(' ')[0];
    
    const marker = L.marker(user.position, {
        icon: L.divIcon({
            html: `<div style="
                background: ${color};
                color: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                border: 2px solid white;
            ">${emoji}</div>`,
            iconSize: [35, 35],
            iconAnchor: [17.5, 35]
        })
    }).bindPopup(`
        <b>${user.name}</b><br>
        <button onclick="handleUserAction('chat','${user.id}')">üí¨ –ß–∞—Ç</button>
        <button onclick="handleUserAction('route',[${user.position}])">üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç</button>
    `);

    marker.on('popupopen', () => {
        document.querySelectorAll('.leaflet-popup-content button').forEach(btn => {
            btn.addEventListener('click', (e) => e.stopPropagation());
        });
    });

    return marker;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π
function handleUserAction(action, data) {
    if (action === 'chat') {
        openChatModal(data);
    } else if (action === 'route') {
        buildRouteToUser(JSON.parse(data));
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
function openChatModal(userId) {
    const user = Array.from(allUsers.values()).find(u => u.id === userId);
    if (!user) return;

    currentChatUserId = userId;
    document.getElementById('chat-with-name').textContent = user.name;
    document.getElementById('chat-modal').style.display = 'block';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
function closeChatModal() {
    document.getElementById('chat-modal').style.display = 'none';
    currentChatUserId = null;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendPrivateMessage() {
    const input = document.getElementById('private-message-input');
    const message = input.value.trim();
    
    if (message && currentChatUserId) {
        socket.emit('privateMessage', {
            to: currentChatUserId,
            text: message
        });
        input.value = '';
    }
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
function buildRouteToUser(targetCoords) {
    if (!currentUser.position) {
        alert('–í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞!');
        return;
    }

    if (routingControl) {
        map.removeControl(routingControl);
    }

    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(currentUser.position),
            L.latLng(targetCoords)
        ],
        routeWhileDragging: true,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        formatter: new L.Routing.Formatter({
            language: 'ru',
            units: 'metric'
        })
    }).addTo(map);

    routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const instructions = routes[0].instructions;
        let html = '<div class="route-instructions">';
        
        instructions.forEach(instruction => {
            html += `<div>${instruction.text}</div>`;
        });
        
        html += '</div>';
        L.popup()
            .setLatLng(targetCoords)
            .setContent(html)
            .openOn(map);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
socket.on('privateMessage', (data) => {
    const messages = document.getElementById('private-chat-messages');
    messages.innerHTML += `<div><b>${data.from}:</b> ${data.text}</div>`;
    messages.scrollTop = messages.scrollHeight;
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', (e) => {
    const modal = document.getElementById('chat-modal');
    if (!modal.contains(e.target) && e.target.closest('.leaflet-popup') === null) {
        closeChatModal();
    }
});
</script>
</body>
</html>
