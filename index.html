<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Adventure Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
    </style>
</head>
<body>
    <!-- –í–µ—Å—å HTML –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ -->

    <script>
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let map;
        let userMarker;
        let userMarkers = new Map();
        let currentUser = {
            id: null,
            name: '',
            status: 'üü¢ –°–≤–æ–±–æ–¥–µ–Ω',
            position: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map').setView([55.751244, 37.618423], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
            
            socket = io('https://adventure-sync-server.onrender.com');
            
            socket.on('connect', () => {
                currentUser.id = socket.id;
                currentUser.name = username;
                socket.emit('register', currentUser);
            });

            // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            socket.on('users', users => updateUserMarkers(users));
            socket.on('position', position => handlePositionUpdate(position));
            socket.on('status', status => handleStatusUpdate(status));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUserMarkers(users) {
            // –£–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            userMarkers.forEach((marker, userId) => {
                if (!users.some(u => u.id === userId)) {
                    map.removeLayer(marker);
                    userMarkers.delete(userId);
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
            users.forEach(user => {
                if (user.id === currentUser.id) return;

                if (userMarkers.has(user.id)) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä
                    const marker = userMarkers.get(user.id);
                    marker.setLatLng(user.position);
                    marker.setPopupContent(`
                        <b>${user.name}</b><br>
                        ${user.status}<br>
                        <button onclick="buildRoute([${user.position}])">–ú–∞—Ä—à—Ä—É—Ç</button>
                    `);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
                    const marker = L.marker(user.position, {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: `<div style="
                                background: ${getStatusColor(user.status)};
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                text-align: center;
                                line-height: 32px;
                                color: white;
                                border: 2px solid white;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            ">${user.status.charAt(0)}</div>`
                        })
                    }).bindPopup(`
                        <b>${user.name}</b><br>
                        ${user.status}<br>
                        <button onclick="buildRoute([${user.position}])">–ú–∞—Ä—à—Ä—É—Ç</button>
                    `).addTo(map);

                    userMarkers.set(user.id, marker);
                }
            });
        }

        // –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
        function getStatusColor(status) {
            const colors = {
                'üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –∑–∞–µ–∑–¥—É': '#ff0000',
                'üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç': '#ff00ff',
                '‚òï –ß–∞–∏ –ø–∏–Ω–∞—é': '#800080',
                '‚õ∞Ô∏è –ü–æ–∫–æ—Ä—è—é –≤–µ—Ä—à–∏–Ω—ã': '#00ff00',
                'üü¢ –°–≤–æ–±–æ–¥–µ–Ω': '#2196F3',
                'üî¥ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å': '#666'
            };
            return colors[status] || '#666';
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    </script>
</body>
</html>
