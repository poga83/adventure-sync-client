<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Стили остаются без изменений */
    </style>
</head>
<body>
    <!-- HTML-структура остается без изменений -->
    
    <script>
        let wakeLock = null;
        let watchId = null;
        let isTracking = false;

        // Функция активации Wake Lock
        async function activateWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock активен');
            } catch (err) {
                console.error('Ошибка Wake Lock:', err);
            }
        }

        // Функция отслеживания геолокации
        function startTracking() {
            if (!navigator.geolocation) {
                alert('Геолокация не поддерживается!');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            };

            watchId = navigator.geolocation.watchPosition(
                position => {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    socket.emit('position', coords);
                    updateMyMarker(coords);
                },
                error => handleGeolocationError(error),
                options
            );

            isTracking = true;
            activateWakeLock();
        }

        // Обработчик изменения видимости страницы
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && isTracking) {
                await activateWakeLock();
            }
        });

        // Функция остановки отслеживания
        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            isTracking = false;
            updateLocationStatus(false);
        }

        // Инициализация Wake Lock при загрузке
        if ('wakeLock' in navigator) {
            document.addEventListener('visibilitychange', activateWakeLock);
            document.addEventListener('fullscreenchange', activateWakeLock);
        }
    </script>
</body>
</html>
