<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        #login-container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
            margin: 2rem auto;
        }

        #app-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }

        #map {
            height: 60vh;
            background: #fff;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .controls {
            padding: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-filter {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
        }

        .leaflet-popup-content button {
            margin: 5px;
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>üöÄ Adventure Sync</h1>
        <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è">
        <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="app-container" style="display:none">
        <div class="controls">
            <select id="status" onchange="updateStatus(this.value)">
                <option value="üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ">üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ</option>
                <option value="üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç">üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç</option>
                <option value="‚òï –ß–∞–∏ –ø–∏–Ω–∞—é">‚òï –ß–∞–∏ –ø–∏–Ω–∞—é</option>
                <option value="‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö">‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö</option>
            </select>
            <button onclick="toggleLocation()">üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º</button>
        </div>

        <div class="status-filter">
            <h4>–§–∏–ª—å—Ç—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤:</h4>
            <label><input type="checkbox" value="üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ" checked> –ú–æ—Ç–æ—Ü–∏–∫–ª–∏—Å—Ç—ã</label>
            <label><input type="checkbox" value="üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç" checked> –ö–æ–Ω—Ü–µ—Ä—Ç—ã</label>
            <label><input type="checkbox" value="‚òï –ß–∞–∏ –ø–∏–Ω–∞—é" checked> –ö–æ—Ñ–µ</label>
            <label><input type="checkbox" value="‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö" checked> –ü–æ—Ö–æ–¥—ã</label>
        </div>

        <div id="map"></div>
    </div>

<script>
let map, userMarker, socket, routingControl;
const userMarkers = new Map();
let isSharingLocation = false;
const statusIcons = {
    'üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ': '#FF0000',
    'üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç': '#FF00FF', 
    '‚òï –ß–∞–∏ –ø–∏–Ω–∞—é': '#800080',
    '‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö': '#00FF00'
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
function initMap(coords = [55.751244, 37.618423]) {
    map = L.map('map').setView(coords, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
function handleLogin() {
    const username = document.getElementById('username').value;
    if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
    
    socket = io('https://adventure-sync-server.onrender.com');
    
    socket.on('connect', () => {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        socket.emit('register', {
            name: username,
            status: document.getElementById('status').value
        });
    });

    socket.on('users', users => updateUsers(users));
    socket.on('position', coords => updateUserPosition(coords));
    
    initMap();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus(status) {
    socket.emit('status', status);
    if (userMarker) {
        userMarker._icon.style.backgroundColor = statusIcons[status];
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
function toggleLocation() {
    if (!isSharingLocation) {
        startLocationTracking();
    } else {
        stopLocationTracking();
    }
}

function startLocationTracking() {
    navigator.geolocation.watchPosition(
        position => {
            const coords = [position.coords.latitude, position.coords.longitude];
            socket.emit('position', coords);
            updateUserPosition(coords);
        },
        error => console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error),
        { enableHighAccuracy: true, maximumAge: 0 }
    );
    isSharingLocation = true;
}

function stopLocationTracking() {
    navigator.geolocation.clearWatch(watchId);
    isSharingLocation = false;
    map.removeLayer(userMarker);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
function updateUsers(users) {
    users.forEach(user => {
        if (!userMarkers.has(user.id)) {
            const marker = L.marker(user.position, {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: `<div style="background:${statusIcons[user.status] || '#666'}">${user.status}</div>`,
                    iconSize: [30, 30]
                })
            }).bindPopup(`
                <b>${user.name}</b>
                <button onclick="buildRoute(${user.position})">–ú–∞—Ä—à—Ä—É—Ç</button>
                <button onclick="startChat('${user.id}')">–ß–∞—Ç</button>
            `).addTo(map);
            
            userMarkers.set(user.id, marker);
        } else {
            userMarkers.get(user.id).setLatLng(user.position);
        }
    });
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
function buildRoute(target) {
    if (routingControl) map.removeControl(routingControl);
    
    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(userMarker.getLatLng()),
            L.latLng(target)
        ]
    }).addTo(map);
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
document.querySelectorAll('.status-filter input').forEach(input => {
    input.addEventListener('change', () => {
        const activeStatuses = [...document.querySelectorAll('.status-filter input:checked')]
            .map(input => input.value);
        
        userMarkers.forEach(marker => {
            const status = marker._popup._content.split('</b>')[1].trim();
            marker.setOpacity(activeStatuses.includes(status) ? 1 : 0.3);
        });
    });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initMap();
</script>
</body>
</html>
