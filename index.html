<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Adventure Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        #login-container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
            margin: 2rem auto;
        }

        #app-container {
            display: none;
            position: relative;
            height: 100vh;
        }

        #map {
            height: 70vh;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 250px;
        }

        .status-control {
            margin-bottom: 15px;
        }

        .filters {
            margin: 15px 0;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .counters {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>Adventure Sync</h1>
        <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è">
        <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="app-container">
        <div class="control-panel">
            <div class="status-control">
                <select id="status-select" onchange="updateStatus()">
                    <option value="üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ">üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ</option>
                    <option value="üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç">üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç</option>
                    <option value="‚òï –ß–∞–∏ –ø–∏–Ω–∞—é">‚òï –ß–∞–∏ –ø–∏–Ω–∞—é</option>
                    <option value="‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö">‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö</option>
                </select>
            </div>
            
            <div class="filters">
                <label><input type="checkbox" checked data-status="üèçÔ∏è"> –ú–æ—Ç–æ—Ü–∏–∫–ª–∏—Å—Ç—ã</label>
                <label><input type="checkbox" checked data-status="üé§"> –ö–æ–Ω—Ü–µ—Ä—Ç—ã</label>
                <label><input type="checkbox" checked data-status="‚òï"> –ß–∞–µ–ø–∏—Ç–∏–µ</label>
                <label><input type="checkbox" checked data-status="‚õ∞Ô∏è"> –ü–æ—Ö–æ–¥—ã</label>
            </div>

            <div class="counters">
                –ê–∫—Ç–∏–≤–Ω—ã—Ö: <span id="active-count">0</span><br>
                –í—Å–µ–≥–æ: <span id="total-count">0</span>
            </div>
        </div>
        <div id="map"></div>
    </div>

<script>
let map, socket, userMarker, watchId;
const userMarkers = new Map();
const statusColors = {
    'üèçÔ∏è –ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ': '#ff4444',
    'üé§ –ò–¥—É –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç': '#ff00ff',
    '‚òï –ß–∞–∏ –ø–∏–Ω–∞—é': '#800080',
    '‚õ∞Ô∏è –í –≥–æ—Ä–∞—Ö': '#00cc00'
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
function initMap() {
    map = L.map('map').setView([55.751244, 37.618423], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}/.png').addTo(map);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus() {
    const newStatus = document.getElementById('status-select').value;
    socket.emit('status_update', newStatus);
    
    if (userMarker) {
        updateMarkerStyle(userMarker, newStatus);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è –º–∞—Ä–∫–µ—Ä–∞
function updateMarkerStyle(marker, status) {
    const color = statusColors[status] || '#666';
    const emoji = status.split(' ')[0];
    
    marker.setIcon(L.divIcon({
        html: `<div style="
            background: ${color};
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid white;
        ">${emoji}</div>`,
        iconSize: [35, 35],
        iconAnchor: [17.5, 35]
    }));
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
    
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    
    initMap();
    connectToServer(username);
}

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
function connectToServer(username) {
    socket = io('https://adventure-sync-server.onrender.com');

    socket.on('connect', () => {
        socket.emit('register', {
            name: username,
            status: document.getElementById('status-select').value
        });
    });

    socket.on('users_update', users => {
        updateUserMarkers(users);
        updateCounters(users);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function updateUserMarkers(users) {
    // –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    userMarkers.forEach((marker, id) => {
        if (!users.some(u => u.id === id)) {
            map.removeLayer(marker);
            userMarkers.delete(id);
        }
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
    users.forEach(user => {
        if (userMarkers.has(user.id)) {
            const marker = userMarkers.get(user.id);
            marker.setLatLng(user.position);
            updateMarkerStyle(marker, user.status);
        } else {
            const marker = L.marker(user.position).addTo(map);
            updateMarkerStyle(marker, user.status);
            userMarkers.set(user.id, marker);
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
function updateCounters(users) {
    document.getElementById('active-count').textContent = 
        users.filter(u => u.position).length;
    document.getElementById('total-count').textContent = users.length;
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
document.querySelectorAll('.filters input').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        const activeStatuses = Array.from(document.querySelectorAll('.filters input:checked'))
            .map(cb => cb.dataset.status);
        
        userMarkers.forEach(marker => {
            const status = marker._icon.innerText;
            const visible = activeStatuses.some(s => status.includes(s));
            marker[visible ? 'addTo' : 'removeFrom'](map);
        });
    });
});
</script>
</body>
</html>
